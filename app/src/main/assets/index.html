<html>
<head>

</head>
<body>
<h1>JsBridge Test</h1>

<div>
    <p>
        <button id="j_showPackageName">showPackageName</button>
    </p>
    <p>

        <button id="j_getUser">getUser</button>
    </p>
</div>

<script>

    window.Proxy = {
        _callbacks: {},
        client_transact: function (server_method_name, server_method_params, client_callback) {
            console.log(server_method_name, server_method_params, client_callback);
            var invoke_info = {
                "_server_method_name": server_method_name
            };
            if (client_callback) {
                var callback_id = new Date().getTime();
                this._callbacks[callback_id] = client_callback;
                invoke_info['_client_callback'] = callback_id;
            }
            window.invoker(invoke_info, server_method_params);
        },
        server_onTransact: function (to_be_invoke_unmarshalling, to_be_param_unmarshalling) {
            console.log('server_onTransact:' + to_be_invoke_unmarshalling, +":" + to_be_param_unmarshalling);
            var invoke_info = JSON.parse(to_be_invoke_unmarshalling);
            var server_method_params = JSON.parse(to_be_param_unmarshalling);
            console.log('server_onTransact', invoke_info, server_method_params);

            var server_method_id = invoke_info['_server_method_id'];
            var server_method_name = invoke_info['_server_method_name'];
            server_method_name = 'success';

            if (server_method_id) {//有 id 表示是回调
                var callback = this._callbacks[server_method_id];
                if (callback) { //找到了回调
                    var fn = callback[server_method_name];
                    if (fn) {
                        fn(server_method_params);
                    }
                }
            } else { //没有 id ，表示是要直接调用某个方法
                var fn = window[server_method_name];
                if (fn) {
                    fn(server_method_params);
                }
            }
        }
    };

    if (location.href.indexOf("workspace") != -1) {
        window.invoker = function (invoke_info, server_method_params) {
            console.log(JSON.stringify(invoke_info), JSON.stringify(server_method_params));
        };
    } else {
        window.invoker = function (invoke_info, server_method_params) {
            JAVA_PROXY.onTransact(JSON.stringify(invoke_info), JSON.stringify(server_method_params));
        };
    }

    var sdk = {
        showPackageName: function (params) {
            var _server_method_name = 'showPackageName';
            var _server_method_params = params;
            window.Proxy.client_transact(_server_method_name, _server_method_params, null);
        },
        getUser: function (params) {
            var _server_method_name = 'getUser';
            var _server_method_params = params;
            var _client_callback = params;
            window.Proxy.client_transact(_server_method_name, _server_method_params, _client_callback);
        }
    };

    //local
    function js_fn_1() {
        document.body.style.background = 'red';
    }

    //client
    function _$(id) {
        return document.getElementById(id);
    }

    _$('j_showPackageName').addEventListener('click', function (e) {
        sdk.showPackageName({
            "success": function (data) {
                console.log('sdk.showPackageName,success', data);
            },
            "fail": function (error) {
                console.log('sdk.showPackageName,fail', data);
            }
        });
    }, false);

    _$('j_getUser').addEventListener('click', function (e) {
        sdk.getUser({
            "name_prefix": "standard_prefix",
            "success": function (user) {
                console.log('sdk.getUser,success:' + user.name);
            },
            "fail": function (error) {
                console.log('sdk.getUser,fail;' + data);
            }
        });
    }, false);

</script>
</body>
</html>