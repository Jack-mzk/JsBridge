<html>
<head>

</head>
<body>
<h1>JsBridge Test</h1>

<div>
    <p>
        <button id="j_showPackageName">showPackageName</button>
    </p>
    <p>
        <button id="j_getUser_succ">getUser success</button>
    </p>
    <p>
        <button id="j_getUser_error">getUser error</button>
    </p>
</div>

<script>

    function InvokeInfo(invoke_info) {
        this.invoke_id = invoke_info['_invoke_id'];
        this.invoke_name = invoke_info['_invoke_name'];

        this.callback_id = invoke_info['_callback_id'];
        this.callback_name = invoke_info['_callback_name'];
    }

    InvokeInfo.prototype = {

        toJSON: function () {
            return {
                "_invoke_id": this.invoke_id,
                "_invoke_name": this.invoke_name,
                "_callback_id": this.callback_id,
                "_callback_name": this.callback_name,
            }
        },

        isCallback: function () {
            return this.invoke_id && this.invoke_id > 0;
        },

        invoke: function (invoke_param) {
            var targetFn = null;
            if (this.isCallback()) {
                var callback = window.JsExecutor._callbacks[this.invoke_id];
                if (callback) { //找到了回调
                    targetFn = callback[this.invoke_name];
                }
            } else {
                targetFn = window.JsExecutor._handlers[this.invoke_name] || window[this.invoke_name];
            }
            if (targetFn) {
                targetFn(this, invoke_param);
            }
        },

        triggerCallback: function (callback_name, callback_param) {
            var invoke_info = new InvokeInfo({
                "_invoke_id": this.callback_id,
                "_invoke_name": callback_name
            });
            console.log(callback_name);
            window.JsExecutor.client_transact_2(invoke_info, callback_param);
        }
    };

    window.JsExecutor = {
        _callbacks: {},
        client_transact_2: function (raw_invoke_info, callback_param) {//callback
            window.invoker(raw_invoke_info, callback_param);
        },


        client_transact: function (server_method_name, server_method_params, client_callback) {
            console.log(server_method_name, server_method_params, client_callback);
            var invoke_info = {
                "_server_method_name": server_method_name
            };
            if (client_callback) {
                var callback_id = new Date().getTime();
                this._callbacks[callback_id] = client_callback;
                invoke_info['_client_callback'] = callback_id;
            }
            window.invoker(invoke_info, server_method_params);
        },

        _handlers: {},
        server_register: function (server_method_name, transact_handler) {
            this._handlers[server_method_name] = transact_handler;
        },

        server_onTransact: function (raw_invoke_info, invoke_param) {
            console.log('server_onTransact:' + raw_invoke_info + "###" + invoke_param);

            if (!raw_invoke_info) {
                return;
            }

            var invoke_info = new InvokeInfo(raw_invoke_info);
            invoke_info.invoke(invoke_param);
        }
    };

    if (location.href.indexOf("workspace") != -1) {
        window.invoker = function (invoke_info, server_method_params) {
            console.log(JSON.stringify(invoke_info), JSON.stringify(server_method_params));
        };
    } else {
        window.invoker = function (invoke_info, server_method_params) {
            JavaExecutor.onTransact(JSON.stringify(invoke_info), JSON.stringify(server_method_params));
        };
    }
    ///////////////////////////////////////////////////////////////////////////

    var sdk = {
        showPackageName: function (params) {
            var _server_method_name = 'showPackageName';
            var _server_method_params = params;
            window.JsExecutor.client_transact(_server_method_name, _server_method_params, null);
        },
        getUser: function (params) {
            var _server_method_name = 'getUser';
            var _server_method_params = params;
            var _client_callback = params;
            window.JsExecutor.client_transact(_server_method_name, _server_method_params, _client_callback);
        }
    };
    ///////////////////////////////////////////////////////////////////////////

    //local
    function js_fn_1() {
        document.body.style.background = 'red';
    }

    window.JsExecutor.server_register('js_fn_1', function (invoke_info, color) {
        console.log(color);
        document.body.style.background = color;
        invoke_info.triggerCallback('success', 'background change to ' + color);
    });
    ///////////////////////////////////////////////////////////////////////////
    //client
    function _$(id, fn) {
        var dom = document.getElementById(id);
        dom.addEventListener('click', fn, false);
    }

    _$('j_showPackageName', function (e) {
        sdk.showPackageName({
            "success": function (data) {
                console.log('sdk.showPackageName,success', data);
            },
            "fail": function (error) {
                console.log('sdk.showPackageName,fail', data);
            }
        })
    });

    _$('j_getUser_succ', function (e) {
        sdk.getUser({
            "name_prefix": "standard_succ",
            "success": function (user) {
                console.log('sdk.getUser,success:' + user.name);
            },
            "fail": function (error) {
                console.log('sdk.getUser,fail;' + data);
            }
        })
    });

    _$('j_getUser_error', function (e) {
        sdk.getUser({
            "name_prefix": "standard_error",
            "success": function (user) {
                console.log('sdk.getUser,success:' + user.name);
            },
            "fail": function (error) {
                console.log('sdk.getUser,fail;' + error.error);
            }
        })
    });

</script>
</body>
</html>